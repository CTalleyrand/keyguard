<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SignTransaction</title>
    <link href="../src/nimiq-style.css" rel="stylesheet">
    <script src="https://cdn.nimiq-testnet.com/v1.4.2/web-offline.js"></script>
    <script src="../src/lib/Key.js"></script>
    <script src="../src/lib/KeyStore.js"></script>
    <script src="../node_modules/@nimiq/rpc/dist/rpc.umd.js"></script>
    <script src="../client/RequestBehavior.js"></script>
    <script src="../client/KeyguardClient.js"></script>

    <style>
        .row {
            margin: 1rem 0;
        }

        label, input {
            display: block;
            margin: 5px;
        }
    </style>
</head>
<body>

<form class="center">
    <div class="row">
        <label>Transaction fee (satoshi)</label>
        <input id="fee" value="0">
    </div>

    <div class="row">
        <label>Transaction data (ascii)</label>
        <input id="data" value="">
    </div>

    <div class="row">
        <label>Key passphrase</label>
        <input id="passphrase" value="password123">
    </div>


    <br><button id="redirect" type="button" class="small">Sign transaction (redirect)</button>
    <br><button id="popup" type="button" class="small">Sign transaction (popup)</button>

    <p id="result"></p>
</form>

<script>
    (async () => {
        await Nimiq.WasmHelper.doImportBrowser();
        Nimiq.GenesisConfig.test();
    })();

    const client = new KeyguardClient();
    client.on(KeyguardClient.Command.SIGN_TRANSACTION, (result, state) => {
        console.log('Keyguard result', result);
        console.log('State', state);

        document.querySelector('#result').textContent = 'TX signed';
        if (state.keyId) {
            KeyStore.instance.remove(state.keyId);
        }
    }, (error, state) => {
        console.error('Keyguard error', error);
        console.log('State', state);

        document.querySelector('#result').textContent = `Error: ${error.message || error}`;
        if (state.keyId) {
            KeyStore.instance.remove(state.keyId);
        }
    });
    client.init();

    document.querySelector('button#redirect').addEventListener('click', async () => {
        signTransactionRedirect(await generateRequest());
    });

    document.querySelector('button#popup').addEventListener('click', async () => {
        client.createPopup(KeyguardClient.Command.SIGN_TRANSACTION);
        signTransactionPopup(await generateRequest());
    });

    async function generateRequest() {
        const txFee = parseInt(document.querySelector('#fee').value) || 0;
        const txData = document.querySelector('#data').value || '';
        const keyPassphrase = document.querySelector('#passphrase').value || '';

        // Generate a random key and put it into the KeyStore.
        const secret = Nimiq.Entropy.generate().serialize();
        const key = new Key(secret, Key.Type.BIP39);
        const passphrase = keyPassphrase ? Nimiq.BufferUtils.fromAscii(keyPassphrase) : undefined;
        await KeyStore.instance.put(key, passphrase);

        const path = "m/0'/0'";
        return {
            keyId: key.id,
            keyPath: path,

            sender: key.deriveAddress(path).serialize(),
            senderLabel: 'Spending Account',
            recipient: Nimiq.Address.fromUserFriendlyAddress('NQ82 HP54 C9D4 2FAG 69QD 6Q71 LURR 5187 0V3X').serialize(),
            recipientLabel: 'amazon.com',
            value: 12300000,
            fee: txFee,
            data: Nimiq.BufferUtils.fromAscii(txData),
            validityStartHeight: 0,
        };
    }

    function signTransactionRedirect(txRequest) {
        return client.signTransaction(txRequest, RedirectRequestBehavior.withLocalState({ keyId: txRequest.keyId }));
    }

    async function signTransactionPopup(txRequest) {
        try {
            const result = await client.signTransaction(txRequest);
            console.log('Keyguard result', result);
            document.querySelector('#result').textContent = 'TX signed';
        } catch (e) {
            console.error('Keyguard error', e);
            document.querySelector('#result').textContent = `Error: ${e.message || e}`;
        }

        KeyStore.instance.remove(txRequest.keyId);
    }
</script>

</body>
</html>
