<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SignTransactionPassPhrase</title>
</head>
<body>
<link href="../src/nimiq-style.css" rel="stylesheet">
<script src="http://cdn.nimiq.com/web-offline.js"></script>
<script src="../src/lib/EncryptionType.js"></script>
<script src="../src/lib/TransactionType.js"></script>
<script src="../src/lib/Key.js"></script>
<script src="../src/lib/Utf8Tools.js"></script>

<div>
    Pass Phrase is 'password'
</div>

<script>
    (async() => {
        const keyguard = window.open('../src/sign-transaction/');

        // We need this check because we call the rpcServer object directly and not via RPC Client
        function checkIfKeyguardReady(resolve) {
            if (keyguard.rpcServer !== undefined) {
                resolve();
            } else {
                self.setTimeout(() => checkIfKeyguardReady(resolve), 25);
            }
        }

        await Promise.all([
            Nimiq.WasmHelper.doImportBrowser(),
            new Promise(resolve => checkIfKeyguardReady(resolve))
        ]);

        Nimiq.GenesisConfig.test();

        keyguard.KeyStore.prototype.getType = async (address) => {
            return EncryptionType.HIGH;
        };

        keyguard.KeyStore.prototype.get = async (signer, passphrase) => {
            // fake delay
            await new Promise(resolve => setTimeout(resolve, 1000));

            const buf = '01080bf074db2535eabf77bb8133743fa5a64259fd19096b11babd0cb2900f7df25d55ad71ca3b5bfee1d6f4b5343fd57ac61075f40c';

            return Key.loadEncrypted(buf, passphrase);
        };

        const txRequest = {
            sender: 'NQ82 HP54 C9D4 2FAG 69QD 6Q71 LURR 5187 0V3X',
            recipient: 'NQ82 HP54 C9D4 2FAG 69QD 6Q71 LURR 5187 0V3X',
            signer: 'NQ82 HP54 C9D4 2FAG 69QD 6Q71 LURR 5187 0V3X',
            value: 10,
            fee: 0,
            network: 'test',
            validityStartHeight: 0,
            type: TransactionType.BASIC
        };

        const result = await keyguard.rpcServer.request(txRequest);

        if (result) {
            console.log(result);
            keyguard.close();
        }
    })();
</script>

</body>
</html>
