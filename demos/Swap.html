<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swap | Keyguard Demo</title>
    <script src="../node_modules/@nimiq/rpc/dist/rpc.umd.js"></script>
    <script src="../node_modules/@nimiq/core-web/web.js"></script>
    <script src="../src/lib/bitcoin/vendor/BitcoinJS.js"></script>
</head>
<body>
<link href="../src/nimiq-style.css" rel="stylesheet">

<div>
    Key ID: <input id="key-id" value="3XGXPOwg2v2hN7prqEVpR6J2TNdtyihKlcb+6R6j+co="><br>
    <button id="swap-nim-btc">Swap NIM -> BTC</button>
    <button id="swap-btc-nim">Swap BTC -> NIM</button>
    <br><br>
    <textarea id="result" rows=20 cols=60></textarea>
</div>

<script>
    document.querySelector('#swap-nim-btc').addEventListener('click', async () => {
        const keyId = document.getElementById('key-id').value;
        if (!keyId) {
            alert('Key ID required');
            return;
        }

        const keyguard = window.open('../src/request/sign-swap/', 'SwapDemo',
            `left=${window.innerWidth / 2 - 350},top=75,width=700,height=850,location=yes,dependent=yes`);
        const rpc = new Rpc.PostMessageRpcClient(keyguard, '*');
        await rpc.init();

        try {
            const result = await rpc.call('request', {
                appName: 'Swap Demo',
                keyId,
                fund: {
                    type: 'NIM',
                    keyPath: "m/44'/242'/0'/0'",
                    sender: Nimiq.Address.fromUserFriendlyAddress('NQ41 D9UN RC7G UMHE 4XA7 R1PL DNCF TH2N 7JQ8').subarray(),
                    senderType: 0, // Account.Type.BASIC
                    value: 2709.79904e5,
                    fee: 0,
                    validityStartHeight: 114000,
                    data: Nimiq.BufferUtils.fromBase64('anlssPDlYuJ5R8hvRtmP3EVjywhona4vd7BI3MCOFNcxBOoUIitb4QMZNYm9TPJr6LpTyq2WJSLYwtBr6jaor6LrJjgvNFcr4gEAEWWF'),
                    // data: new Uint8Array([
                    //     // Refund address (my own)
                    //     1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
                    //     // Redeem address (of swap partner)
                    //     21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
                    //     // Hash algorithm (Hash.Algorithm.SHA256)
                    //     3,
                    //     // Hash root (32 bytes)
                    //     // new Uint8Array(await window.crypto.subtle.digest('SHA-256', new Uint8Array(32))),
                    //     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    //     // Hash count
                    //     1,
                    //     // Timeout (in block height, as Uint32)
                    //     0, 0, 0, 200,
                    // ]),
                    flags: Nimiq.Transaction.Flag.CONTRACT_CREATION,
                },
                redeem: {
                    type: 'BTC',
                    inputs: [{
                        keyPath: "m/84'/1'/0'/0/0", // The path to the BTC HTLC redeem pubkey
                        transactionHash: "76882f8dec14e710b4bc7e8a31bda03f6a9bbc0ac7cf826bbefd20ed452ffaae",
                        outputIndex: 0,
                        outputScript: "00207dc5d023300b2bdd79c3c1eb145a4da435a3ff5d1ecea7f1618ab659c2057e64", // HTLC address script pub key
                        witnessScript: "6382012088a820193589bd4cf26be8ba53caad962522d8c2d06bea36a8afa2eb26382f34572be28876a91484eb9bcbd90ce7d3360992259e4b9b818215a96088ac67044934565fb17576a91457f4babc23d2369572394cf80f28daeb9c3b58f188ac68", // HTLC script
                        value: 0.001004e8,
                    }],
                    changeOutput: {
                        keyPath: "m/84'/1'/0'/0/1",
                        address: "tb1qm37aps59r86g79jg5xh8ecgfqfncv92wzfyyx7",
                        value: 0.001000e8, // 400 sats fee
                    },
                },

                // Data needed for display
                // fiatCurrency: string,
                // nimFiatRate: number,
                // btcFiatRate: number,
                // serviceNetworkFee: number, // Luna or Sats, depending which one gets funded
                // nimiq: Array<{
                //     address: string,
                //     label: string,
                //     balance: number, // Luna
                // }>,
                // bitcoin: {
                //     balance: number, // Sats
                // },
            });
            document.getElementById('result').value = JSON.stringify(result);
            console.log('Keyguard result:', result);
        } catch (e) {
            alert(e.message);
        }

        keyguard.close();
    });

    document.querySelector('#swap-btc-nim').addEventListener('click', async () => {
        const keyId = document.getElementById('key-id').value;
        if (!keyId) {
            alert('Key ID required');
            return;
        }

        const keyguard = window.open('../src/request/sign-swap/', 'SwapDemo',
            `left=${window.innerWidth / 2 - 350},top=75,width=700,height=850,location=yes,dependent=yes`);
        const rpc = new Rpc.PostMessageRpcClient(keyguard, '*');
        await rpc.init();

        try {
            const result = await rpc.call('request', {
                appName: 'Swap Demo',
                keyId,
                fund: {
                    type: 'BTC',
                    inputs: [{
                        keyPath: "m/49'/1'/0'/0/0",
                        transactionHash: "0000000000000000000000000000000000000000000000000000000000000000",
                        outputIndex: 0,
                        outputScript: "0000000000000000000000000000000000000000000000",
                        value: 0.1e8,
                    }, {
                        keyPath: "m/49'/1'/0'/0/1",
                        transactionHash: "0000000000000000000000000000000000000000000000000000000000000000",
                        outputIndex: 1,
                        outputScript: "0000000000000000000000000000000000000000000000",
                        value: 0.1e8,
                    }],
                    recipientOutput: {
                        address: "bc1q9szt96cq4vulpqu5m96sspcu0mt3rvv0qmwl5rxvyxejlw08zp7qnnyg3c", // HTLC address
                        value: 0.1e8,
                    },
                    changeOutput: {
                        keyPath: "m/49'/1'/0'/1/0",
                        value: 0.099996e8, // 400 sats fee
                    }
                },

                redeem: {
                    type: 'NIM',
                    keyPath: "m/44'/242'/0'/0'",
                    sender: new Uint8Array(20), // HTLC address
                    senderType: 2, // Account.Type.HTLC
                    value: 1000e8,
                    fee: 0,
                    validityStartHeight: 100,
                },

                // Data needed for display
                // fiatCurrency: string,
                // nimFiatRate: number,
                // btcFiatRate: number,
                // serviceNetworkFee: number, // Luna or Sats, depending which one gets funded
                // nimiq: Array<{
                //     address: string,
                //     label: string,
                //     balance: number, // Luna
                // }>,
                // bitcoin: {
                //     balance: number, // Sats
                // },
            });
            document.getElementById('result').value = JSON.stringify(result);
            console.log('Keyguard result:', result);
        } catch (e) {
            alert(e.message);
        }

        keyguard.close();
    });
</script>

</body>
</html>
