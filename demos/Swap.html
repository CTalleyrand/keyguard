<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swap | Keyguard Demo</title>
    <script src="../node_modules/@nimiq/rpc/dist/rpc.umd.js"></script>
    <script src="../node_modules/@nimiq/core-web/web-offline.js"></script>
    <script src="../src/lib/bitcoin/vendor/NodeBuffer.js"></script>
    <script src="../src/lib/bitcoin/vendor/BitcoinJS.js"></script>
</head>
<body>
<link href="../src/nimiq-style.css" rel="stylesheet">

<div>
    Key ID: <input id="key-id" value="3XGXPOwg2v2hN7prqEVpR6J2TNdtyihKlcb+6R6j+co="><br>
    <button id="swap-nim-btc">Swap NIM -> BTC</button>
    <button id="swap-btc-nim">Swap BTC -> NIM</button>
    <br><br>
    <textarea id="result" rows=20 cols=60></textarea>
</div>

<script>
    document.querySelector('#swap-nim-btc').addEventListener('click', async () => {
        const keyId = document.getElementById('key-id').value;
        if (!keyId) {
            alert('Key ID required');
            return;
        }

        const keyguard = window.open('../src/request/sign-swap/', 'SwapDemo',
            `left=${window.innerWidth / 2 - 350},top=75,width=700,height=850,location=yes,dependent=yes`);
        const rpc = new Rpc.PostMessageRpcClient(keyguard, '*');
        await rpc.init();

        try {
            const result = await rpc.call('request', {
                appName: 'Swap Demo',
                keyId,
                fund: {
                    type: 'NIM',
                    keyPath: "m/44'/242'/0'/0'",
                    sender: Nimiq.Address.fromUserFriendlyAddress('NQ41 D9UN RC7G UMHE 4XA7 R1PL DNCF TH2N 7JQ8').subarray(),
                    senderType: 0, // Account.Type.BASIC
                    value: 2709.79904e5,
                    fee: 0,
                    validityStartHeight: 1140000,
                    data: Nimiq.BufferUtils.fromBase64('anlssPDlYuJ5R8hvRtmP3EVjywhona4vd7BI3MCOFNcxBOoUIitb4QMZNYm9TPJr6LpTyq2WJSLYwtBr6jaor6LrJjgvNFcr4gEAEWWF'),
                    flags: Nimiq.Transaction.Flag.CONTRACT_CREATION,
                },
                redeem: {
                    type: 'BTC',
                    inputs: [{
                        keyPath: "m/84'/1'/0'/0/0", // The path to the BTC HTLC redeem pubkey
                        transactionHash: "76882f8dec14e710b4bc7e8a31bda03f6a9bbc0ac7cf826bbefd20ed452ffaae",
                        outputIndex: 0,
                        outputScript: "00207dc5d023300b2bdd79c3c1eb145a4da435a3ff5d1ecea7f1618ab659c2057e64", // HTLC address script pub key
                        witnessScript: "6382012088a820193589bd4cf26be8ba53caad962522d8c2d06bea36a8afa2eb26382f34572be28876a91484eb9bcbd90ce7d3360992259e4b9b818215a96088ac67044934565fb17576a91457f4babc23d2369572394cf80f28daeb9c3b58f188ac68", // HTLC script
                        value: 0.001004e8,
                    }],
                    changeOutput: {
                        keyPath: "m/84'/1'/0'/0/1",
                        value: 0.001000e8, // 400 sats fee
                    },
                },

                // Data needed for display
                // fiatCurrency: string,
                // nimFiatRate: number,
                // btcFiatRate: number,
                // serviceNetworkFee: number, // Luna or Sats, depending which one gets funded
                // nimiq: Array<{
                //     address: string,
                //     label: string,
                //     balance: number, // Luna
                // }>,
                // bitcoin: {
                //     balance: number, // Sats
                // },
            });
            document.getElementById('result').value = JSON.stringify(result);
            console.log('Keyguard result:', result);
        } catch (e) {
            document.getElementById('result').value = `ERROR: ${e.message}`;
        }

        keyguard.close();
    });

    document.querySelector('#swap-btc-nim').addEventListener('click', async () => {
        const keyId = document.getElementById('key-id').value;
        if (!keyId) {
            alert('Key ID required');
            return;
        }

        const keyguard = window.open('../src/request/sign-swap/', 'SwapDemo',
            `left=${window.innerWidth / 2 - 350},top=75,width=700,height=850,location=yes,dependent=yes`);
        const rpc = new Rpc.PostMessageRpcClient(keyguard, '*');
        await rpc.init();

        try {
            const result = await rpc.call('request', {
                appName: 'Swap Demo',
                keyId,
                fund: {
                    type: 'BTC',
                    inputs: [{
                        keyPath: "m/84'/1'/0'/0/0",
                        transactionHash: "0000000000000000000000000000000000000000000000000000000000000000",
                        outputIndex: 0,
                        outputScript: "001484eb9bcbd90ce7d3360992259e4b9b818215a960",
                        value: 0.001e8,
                    }, {
                        keyPath: "m/84'/1'/0'/0/0",
                        transactionHash: "0000000000000000000000000000000000000000000000000000000000000000",
                        outputIndex: 1,
                        outputScript: "001484eb9bcbd90ce7d3360992259e4b9b818215a960",
                        value: 0.001e8,
                    }],
                    recipientOutput: {
                        address: "tb1qkg69q2pmq8yncjusk2h77vru99rk8n6pcxdxzzzseupaqc2x64ts4uhrj8", // HTLC address
                        value: 0.00075736e8,
                    },
                    changeOutput: {
                        keyPath: "m/84'/1'/0'/1/0",
                        value: 0.00123864e8, // 400 sats fee
                    },
                    htlcScript: Nimiq.BufferUtils.fromHex('6382012088a8204b268b25df99a2edb5d9fb59d4ad56402f429a47c751069918a9790743c16b788876a9146ec1c15aa31a3fe4da55ed81fc264a56bae75c7888ac6704cb53565fb17576a91484eb9bcbd90ce7d3360992259e4b9b818215a96088ac68'), // HTLC script
                    refundKeyPath: "m/84'/1'/0'/0/0",
                },

                redeem: {
                    type: 'NIM',
                    keyPath: "m/44'/242'/0'/0'",
                    sender: Nimiq.Address.fromUserFriendlyAddress('NQ32 71G4 AQ88 RVA4 4XYC CH39 V2AG HTAM S0YL').subarray(),
                    senderType: 2, // Account.Type.HTLC
                    recipient: Nimiq.Address.fromUserFriendlyAddress('NQ41 D9UN RC7G UMHE 4XA7 R1PL DNCF TH2N 7JQ8').subarray(),
                    value: 2000e5,
                    fee: 0,
                    validityStartHeight: 1140000,
                    htlcData: Nimiq.BufferUtils.fromBase64('aJ2uL3ewSNzAjhTXMQTqFCIrW+FqeWyw8OVi4nlHyG9G2Y/cRWPLCANLJosl35mi7bXZ+1nUrVZAL0KaR8dRBpkYqXkHQ8FreAEAEWYf'), // HTLC data
                },

                // Data needed for display
                // fiatCurrency: string,
                // nimFiatRate: number,
                // btcFiatRate: number,
                // serviceNetworkFee: number, // Luna or Sats, depending which one gets funded
                // nimiq: Array<{
                //     address: string,
                //     label: string,
                //     balance: number, // Luna
                // }>,
                // bitcoin: {
                //     balance: number, // Sats
                // },
            });
            document.getElementById('result').value = JSON.stringify(result);
            console.log('Keyguard result:', result);
        } catch (e) {
            document.getElementById('result').value = `ERROR: ${e.message}`;
        }

        keyguard.close();
    });
</script>

</body>
</html>
